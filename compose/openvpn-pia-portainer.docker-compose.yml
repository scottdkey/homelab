services:
  openvpn-pia:
    # Combined OpenVPN + Privoxy container
    # Handles VPN connection and provides HTTP proxy
    # For Portainer deployment - uses image from GitHub Container Registry
    # Set VPN_IMAGE environment variable or use default from your GitHub username
    # Example: VPN_IMAGE=ghcr.io/username/vpn:latest
    image: ${VPN_IMAGE:-ghcr.io/scottdkey/vpn:latest}
    container_name: openvpn-pia
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - TZ=Etc/UTC
      # Set UPDATE_CONFIGS=true to automatically download PIA configs on startup
      # This is recommended for first-time setup
      - UPDATE_CONFIGS=${UPDATE_CONFIGS:-true}
      # Optional: Set REGION to select a specific PIA server region
      # Examples: us_california, us-california, uk_london, montreal, etc.
      # PIA configs use underscores: us_california.ovpn, uk_london.ovpn
      # Hyphens will be converted to underscores automatically
      # If not set, defaults to first available config
      - REGION=${REGION:-}
      # Optional: PIA credentials via environment variables
      # If both are set, auth.txt will be created/updated automatically
      # Alternative: Create /config/auth.txt manually on the host
      - PIA_USERNAME=${PIA_USERNAME:-}
      - PIA_PASSWORD=${PIA_PASSWORD:-}
      # Optional: Set DEBUG=true to print environment variables on startup
      - DEBUG=${DEBUG:-false}
    volumes:
      # Mount OpenVPN config and auth files from user's home directory
      # REQUIRED: Set USER environment variable in Portainer to your username
      # Example: USER=test-user -> /home/test-user/config/vpn
      # If UPDATE_CONFIGS=true, volume must be writable (no :ro)
      - /home/${USER}/config/vpn:/config
      - openvpn_logs:/var/log/openvpn
    ports:
      # HTTP proxy port (Privoxy)
      # Format: "host-port:container-port" or "host-ip:host-port:container-port"
      # Current: binds to all host interfaces (0.0.0.0:8888)
      # To bind to specific IP: use "10.10.10.14:8888:8888/tcp"
      # Access from host at: http://10.10.10.14:8888
      # Access from other containers at: http://openvpn-pia:8888
      - "8888:8888/tcp"
    networks:
      - vpn_network
    restart: unless-stopped

volumes:
  openvpn_logs:
    name: openvpn_logs

networks:
  vpn_network:
    name: vpn_network
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: 172.20.0.0/16
        - subnet: fd00:172:20::/64 # ULA (Unique Local Address) - safe to use without global IPv6
