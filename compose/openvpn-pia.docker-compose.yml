services:
  openvpn-pia:
    # Combined OpenVPN + Privoxy container
    # Handles VPN connection and provides HTTP proxy
    # For LOCAL DEVELOPMENT - builds from source
    # For Portainer deployment, use: openvpn-pia-portainer.docker-compose.yml
    build:
      context: ../openvpn-container
      dockerfile: Dockerfile
    # Set VPN_IMAGE environment variable or use default from your GitHub username
    # Example: VPN_IMAGE=ghcr.io/username/vpn:latest
    image: ${VPN_IMAGE:-ghcr.io/${GITHUB_USER}/vpn:latest}
    container_name: openvpn-pia
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun
    # Note: Host network mode doesn't work on macOS Docker Desktop
    # Using bridge network with port mapping instead
    # OpenVPN connection issues may persist due to Docker network isolation
    networks:
      - vpn_network
    ports:
      # HTTP proxy port (Privoxy)
      - "8888:8888/tcp"
    environment:
      - TZ=Etc/UTC
      # Set UPDATE_CONFIGS=true to download fresh PIA configs on startup
      - UPDATE_CONFIGS=${UPDATE_CONFIGS:-false}
    volumes:
      # Mount OpenVPN config and auth files from user's home directory
      # Set USER environment variable to specify which user's home directory to use
      # Defaults to current user if not set: /home/${USER:-$USER}/config/vpn
      # Example: USER=testUser -> /home/testUser/config/vpn
      # Note: Remove :ro if using UPDATE_CONFIGS to allow writing downloaded configs
      - /home/${USER}/config/vpn:/config
      - openvpn_logs:/var/log/openvpn
    restart: unless-stopped

volumes:
  openvpn_logs:
    name: openvpn_logs

networks:
  vpn_network:
    name: vpn_network
    driver: bridge
