# .envrc - direnv configuration for Halvor
# This file should load environment variables from 1Password vault
# 
# To use:
# 1. Install direnv: brew install direnv (or your package manager)
# 2. Install 1Password CLI: brew install --cask 1password-cli
# 3. Copy this file to .envrc: cp .envrc.example .envrc
# 4. Update the vault and item references below
# 5. Run: direnv allow

# Load environment variables from 1Password vault
# Format: op://vault/item/field
# The vault and item name should match your 1Password setup
# To find your vault name: op vault list
# To find items in a vault: op item list --vault "VaultName"

# Detect vault name automatically (looks for vaults with "automation" in the name)
# Or set manually: VAULT_NAME="automations"
VAULT_NAME=$(op vault list --format json 2>/dev/null | jq -r '.[] | select(.name | test("automation"; "i")) | .name' 2>/dev/null | head -1 || echo "automations")
ITEM_NAME="halvor"

# Automatically export all fields from the 1Password item as environment variables
# Add new fields to the vault and they'll automatically be available
# Optimized: Fetch entire item once, extract all values from JSON (no per-field API calls)
ITEM_JSON=$(op item get "${ITEM_NAME}" --vault "${VAULT_NAME}" --format json 2>/dev/null)

# Store field names and values in a temp file for display (since while loop runs in subshell)
# Format: field_name\tfield_value
TEMP_FIELDS=$(mktemp)
echo "$ITEM_JSON" | jq -r '.fields[] | 
  select(.type == "STRING" or .type == "CONCEALED" or .type == "EMAIL" or .type == "URL") | 
  select(.label != null and .label != "") | 
  select(.value != null and .value != "") |
  "\(.label)\t\(.value)"' 2>/dev/null > "$TEMP_FIELDS"

# Export all fields that have values in the JSON (most fields)
while IFS=$'\t' read -r field_name field_value; do
  if [ -n "$field_name" ] && [ -n "$field_value" ]; then
    export "${field_name}"="${field_value}"
  fi
done < "$TEMP_FIELDS"

# Display loaded environment variables (obfuscate sensitive values)
# Output to stderr so direnv displays it
LOADED_COUNT=$(wc -l < "$TEMP_FIELDS" 2>/dev/null | tr -d ' ' || echo "0")
if [ "$LOADED_COUNT" -gt 0 ]; then
  echo "âœ“ Loaded ${LOADED_COUNT} environment variable(s) from 1Password vault '${VAULT_NAME}' item '${ITEM_NAME}':" >&2
  while IFS=$'\t' read -r var_name var_value; do
    # Check if variable name suggests it's sensitive
    if echo "$var_name" | grep -qiE "(PASSWORD|TOKEN|SECRET|KEY|CREDENTIAL)"; then
      echo "  ${var_name}=***hidden***" >&2
    else
      # Truncate long values for display
      if [ ${#var_value} -gt 50 ]; then
        echo "  ${var_name}=${var_value:0:47}..." >&2
      else
        echo "  ${var_name}=${var_value}" >&2
      fi
    fi
  done < "$TEMP_FIELDS"
fi
rm -f "$TEMP_FIELDS"
