name: Build and Release Linux

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build:
        description: "Build Linux CLI"
        required: false
        type: boolean
        default: true
      release:
        description: "Release Linux CLI (requires build first)"
        required: false
        type: boolean
        default: false
      version:
        description: "Version to release (defaults to Cargo.toml version)"
        required: false
        type: string
      experimental:
        description: "Create experimental release (defaults to true for push events)"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  actions: write

env:
  RUST_VERSION: stable

jobs:
  check-changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.check.outputs.src }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/check-changes
        id: check
        if: github.event_name == 'push'
      - name: Set default output for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: echo "src=false" >> $GITHUB_OUTPUT

  build:
    name: Build Linux CLI
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && needs.check-changes.outputs.src == 'true') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build == 'true')
    needs:
      - check-changes
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-gnu
          # - aarch64-unknown-linux-musl  # Temporarily disabled - toolchain download issues
          - riscv64gc-unknown-linux-gnu
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust build environment
        uses: ./.github/actions/setup-rust-build
        with:
          target: ${{ matrix.target }}

      - name: Install Linux build dependencies
        if: startsWith(matrix.target, 'x86_64-unknown-linux') || startsWith(matrix.target, 'aarch64-unknown-linux') || startsWith(matrix.target, 'riscv64gc-unknown-linux')
        id: deps
        uses: ./.github/actions/install-linux-deps
        with:
          target: ${{ matrix.target }}

      - name: Build Rust CLI
        uses: ./.github/actions/build-rust-cli
        with:
          target: ${{ matrix.target }}
          skip_target: ${{ steps.deps.outputs.skip_target }}

      - name: Upload artifact
        uses: ./.github/actions/upload-rust-artifact
        with:
          target: ${{ matrix.target }}
          binary_path: target/${{ matrix.target }}/release/hal
          skip_target: ${{ steps.deps.outputs.skip_target }}

  release:
    name: Release Linux CLI
    runs-on: ubuntu-latest
    needs: [check-changes, build]
    if: |
      (github.event_name == 'push' && needs.check-changes.outputs.src == 'true' && needs.build.result != 'failure') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine experimental flag
        id: exp_flag
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.experimental }}" == "true" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
          else
            echo "value=false" >> $GITHUB_OUTPUT
          fi

      - name: Release CLI
        uses: ./.github/actions/release-cli
        with:
          version_input: ${{ github.event.inputs.version }}
          platform: linux
          binary_name: hal
          archive_extension: .tar.gz
          event_name: ${{ github.event_name }}
          experimental_input: ${{ steps.exp_flag.outputs.value }}
