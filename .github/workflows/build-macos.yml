name: Build and Release macOS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build:
        description: "Build macOS CLI"
        required: false
        type: boolean
        default: true
      release:
        description: "Release macOS CLI (requires build first)"
        required: false
        type: boolean
        default: false
      version:
        description: "Version to release (defaults to Cargo.toml version)"
        required: false
        type: string
      experimental:
        description: "Create experimental release (defaults to true for push events)"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  actions: write

env:
  RUST_VERSION: stable

jobs:
  check-changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.check.outputs.src }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/check-changes
        id: check
        if: github.event_name == 'push'
      - name: Set default output for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: echo "src=false" >> $GITHUB_OUTPUT

  build:
    name: Build macOS CLI
    runs-on: macos-14
    if: |
      (github.event_name == 'push' && needs.check-changes.outputs.src == 'true') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build == 'true')
    needs: check-changes
    strategy:
      matrix:
        target:
          - x86_64-apple-darwin
          - aarch64-apple-darwin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust build environment
        uses: ./.github/actions/setup-rust-build
        with:
          target: ${{ matrix.target }}

      - name: Build Rust CLI
        uses: ./.github/actions/build-rust-cli
        with:
          target: ${{ matrix.target }}
          unset_macos_deployment_target: "true"

      - name: Upload artifact
        uses: ./.github/actions/upload-rust-artifact
        with:
          target: ${{ matrix.target }}
          binary_path: target/${{ matrix.target }}/release/hal

  release:
    name: Release macOS CLI
    runs-on: ubuntu-latest
    needs: [check-changes, build]
    if: |
      (github.event_name == 'push' && needs.check-changes.outputs.src == 'true' && needs.build.result != 'failure') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true' && (needs.build.result == 'success' || needs.build.result == 'skipped'))
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine experimental flag
        id: exp_flag
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Experimental input: ${{ github.event.inputs.experimental }}"
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
            echo "Push event - setting experimental to true"
          elif [ "${{ github.event.inputs.experimental }}" == "true" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
            echo "Experimental input is true - setting experimental to true"
          else
            echo "value=false" >> $GITHUB_OUTPUT
            echo "Experimental input is false or not set - setting experimental to false"
          fi

      - name: Release CLI
        uses: ./.github/actions/release-cli
        with:
          version_input: ${{ github.event.inputs.version }}
          platform: darwin
          binary_name: hal
          archive_extension: .tar.gz
          event_name: ${{ github.event_name }}
          experimental_input: ${{ steps.exp_flag.outputs.value }}
