name: Build and Release macOS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build:
        description: "Build macOS CLI"
        required: false
        type: boolean
        default: true
      release:
        description: "Release macOS CLI (requires build first)"
        required: false
        type: boolean
        default: false
      version:
        description: "Version to release (defaults to Cargo.toml version)"
        required: false
        type: string
      experimental:
        description: "Create experimental release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

env:
  RUST_VERSION: stable

jobs:
  check-changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      src: ${{ steps.check.outputs.src }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/check-changes
        id: check

  build:
    name: Build macOS CLI
    runs-on: macos-14
    if: |
      (github.event_name == 'push' && (needs.check-changes.outputs.src == 'true' || always())) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build == 'true')
    needs: check-changes
    strategy:
      matrix:
        target:
          - x86_64-apple-darwin
          - aarch64-apple-darwin
    steps:
      - name: Setup Rust build environment
        uses: ./.github/actions/setup-rust-build
        with:
          target: ${{ matrix.target }}

      - name: Build Rust CLI
        uses: ./.github/actions/build-rust-cli
        with:
          target: ${{ matrix.target }}
          unset_macos_deployment_target: "true"

      - name: Upload artifact
        uses: ./.github/actions/upload-rust-artifact
        with:
          target: ${{ matrix.target }}
          binary_path: target/${{ matrix.target }}/release/hal

  release:
    name: Release macOS CLI
    runs-on: ubuntu-latest
    needs: [check-changes, build]
    if: |
      (github.event_name == 'push' && needs.build.result == 'success') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true' && (needs.build.result == 'success' || needs.build.result == 'skipped'))
    permissions:
      contents: write
    steps:
      - name: Release CLI
        uses: ./.github/actions/release-cli
        with:
          version_input: ${{ github.event.inputs.version }}
          platform: darwin
          binary_name: hal
          archive_extension: .tar.gz
          event_name: ${{ github.event_name }}
          experimental_input: ${{ github.event.inputs.experimental }}
