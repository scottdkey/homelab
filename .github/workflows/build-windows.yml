name: Build and Release Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build:
        description: "Build Windows CLI"
        required: false
        type: boolean
        default: true
      release:
        description: "Release Windows CLI (requires build first)"
        required: false
        type: boolean
        default: false
      version:
        description: "Version to release (defaults to Cargo.toml version)"
        required: false
        type: string
      experimental:
        description: "Create experimental release (defaults to true for push events)"
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  actions: write

env:
  RUST_VERSION: stable

jobs:
  check-changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.check.outputs.src }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/check-changes
        id: check
        if: github.event_name == 'push'
      - name: Set default output for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: echo "src=false" >> $GITHUB_OUTPUT

  build:
    name: Build Windows CLI
    runs-on: windows-latest
    if: |
      (github.event_name == 'push' && needs.check-changes.outputs.src == 'true') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build == 'true')
    needs: check-changes
    strategy:
      matrix:
        target:
          - x86_64-pc-windows-msvc
          - aarch64-pc-windows-msvc
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust build environment
        uses: ./.github/actions/setup-rust-build
        with:
          target: ${{ matrix.target }}

      - name: Install Clang for ARM64 Windows builds
        if: matrix.target == 'aarch64-pc-windows-msvc'
        shell: pwsh
        run: |
          Write-Host "Installing LLVM/Clang for ARM64 Windows cross-compilation..."

          # Check if clang is already available
          $clangPath = Get-Command clang -ErrorAction SilentlyContinue
          if ($clangPath) {
            Write-Host "Clang already available at: $($clangPath.Source)"
            clang --version
            $clangFound = $true
          } else {
            Write-Host "Clang not found in PATH, checking common locations..."
            $possiblePaths = @(
              "C:\Program Files\LLVM\bin",
              "C:\Program Files (x86)\LLVM\bin",
              "C:\tools\llvm\bin"
            )
            $clangFound = $false
            foreach ($path in $possiblePaths) {
              if (Test-Path "$path\clang.exe") {
                Write-Host "Found clang at: $path"
                echo "$path" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                $env:PATH = "$path;$env:PATH"
                clang --version
                $clangFound = $true
                break
              }
            }
            
            if (-not $clangFound) {
              Write-Host "Clang not found, installing via Chocolatey..."
              # Check if Chocolatey is available
              $chocoPath = Get-Command choco -ErrorAction SilentlyContinue
              if (-not $chocoPath) {
                Write-Host "Chocolatey not found, installing..."
                Set-ExecutionPolicy Bypass -Scope Process -Force
                [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
                iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
              }
              
              choco install llvm --version=17.0.6 -y --no-progress
              $llvmPath = "C:\Program Files\LLVM\bin"
              if (Test-Path $llvmPath) {
                Write-Host "Adding LLVM to PATH: $llvmPath"
                $env:PATH = "$llvmPath;$env:PATH"
                echo "$llvmPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                
                # Verify installation
                clang --version
                Write-Host "✓ Clang installed successfully"
                $clangFound = $true
              } else {
                Write-Host "❌ Error: LLVM installation failed or path not found"
                exit 1
              }
            }
          }

          if ($clangFound) {
            # Set environment variables for ring crate
            Write-Host "Setting up environment variables for ring crate..."
            Write-Host "CC=clang" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "CXX=clang++" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "CC_aarch64_pc_windows_msvc=clang" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "CXX_aarch64_pc_windows_msvc=clang++" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "✓ Environment configured for ARM64 Windows builds"
          } else {
            Write-Host "❌ Error: Could not find or install clang"
            exit 1
          }

      - name: Build Rust CLI
        uses: ./.github/actions/build-rust-cli
        with:
          target: ${{ matrix.target }}

      - name: Upload artifact
        uses: ./.github/actions/upload-rust-artifact
        with:
          target: ${{ matrix.target }}
          binary_path: target/${{ matrix.target }}/release/hal.exe

  release:
    name: Release Windows CLI
    runs-on: ubuntu-latest
    needs: [check-changes, build]
    if: |
      (github.event_name == 'push' && needs.check-changes.outputs.src == 'true' && needs.build.result != 'failure') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine experimental flag
        id: exp_flag
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.experimental }}" == "true" ]; then
            echo "value=true" >> $GITHUB_OUTPUT
          else
            echo "value=false" >> $GITHUB_OUTPUT
          fi

      - name: Release CLI
        uses: ./.github/actions/release-cli
        with:
          version_input: ${{ github.event.inputs.version }}
          platform: windows
          binary_name: hal.exe
          archive_extension: .zip
          event_name: ${{ github.event_name }}
          experimental_input: ${{ steps.exp_flag.outputs.value }}
