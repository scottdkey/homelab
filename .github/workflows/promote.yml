name: Promote Code

on:
  workflow_dispatch:
    inputs:
      from_branch:
        description: "Source branch to promote from"
        required: true
        type: choice
        options:
          - alpha
          - beta
      to_branch:
        description: "Target branch to promote to"
        required: true
        type: choice
        options:
          - beta
          - main
      create_tag:
        description: "Create a tag for this promotion"
        required: false
        type: boolean
        default: false
      tag_name:
        description: "Tag name (optional, defaults to promotion-{timestamp})"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-promotion:
    name: Validate Promotion
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate promotion path
        id: validate
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          # Validate promotion path
          if [ "$FROM" == "alpha" ] && [ "$TO" == "beta" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✓ Valid promotion: alpha -> beta"
          elif [ "$FROM" == "beta" ] && [ "$TO" == "main" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✓ Valid promotion: beta -> main"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "✗ Invalid promotion path: $FROM -> $TO"
            echo "  Valid paths: alpha -> beta, beta -> main"
            exit 1
          fi

      - name: Check if branches exist
        id: check_branches
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          # Fetch all branches
          git fetch --all

          # Check if source branch exists
          if ! git show-ref --verify --quiet refs/remotes/origin/$FROM; then
            echo "✗ Source branch '$FROM' does not exist"
            exit 1
          fi

          # Check if target branch exists
          if ! git show-ref --verify --quiet refs/remotes/origin/$TO; then
            echo "✗ Target branch '$TO' does not exist"
            exit 1
          fi

          echo "✓ Both branches exist"

      - name: Check for uncommitted changes
        id: check_changes
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          # Get latest commits from both branches
          git fetch origin $FROM 2>/dev/null || true
          git fetch origin $TO 2>/dev/null || true

          # Check if source has commits not in target
          COMMITS_AHEAD=$(git rev-list --count origin/$TO..origin/$FROM 2>/dev/null || echo "0")

          if [ "$COMMITS_AHEAD" == "0" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "⚠ No new commits to promote (target branch is up to date)"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✓ Found $COMMITS_AHEAD commit(s) to promote"
            
            # List commits that will be promoted
            echo ""
            echo "Commits to be promoted:"
            git log --oneline origin/$TO..origin/$FROM | head -10
          fi

  create-promotion-pr:
    name: Create Promotion PR
    runs-on: ubuntu-latest
    needs: validate-promotion
    if: |
      needs.validate-promotion.outputs.valid == 'true' &&
      needs.validate-promotion.outputs.has_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create promotion branch
        id: create_branch
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="promote/$FROM-to-$TO-$TIMESTAMP"

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Creating promotion branch: $BRANCH_NAME"

          # Fetch all branches
          git fetch --all

          # Create branch from target branch
          git checkout -b $BRANCH_NAME origin/$TO

          # Merge source branch into promotion branch
          git merge --no-ff --no-edit origin/$FROM -m "chore: promote code from $FROM to $TO

          Promoted via GitHub Actions workflow
          Source: $FROM
          Target: $TO
          Triggered by: ${{ github.actor }}
          Workflow run: ${{ github.run_id }}"

          # Push the promotion branch
          git push origin $BRANCH_NAME

          echo "✓ Created promotion branch: $BRANCH_NAME"

      - name: Increment version (for beta -> main promotion)
        if: github.event.inputs.from_branch == 'beta' && github.event.inputs.to_branch == 'main'
        id: increment_version
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"
          BRANCH_NAME="${{ steps.create_branch.outputs.branch }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Incrementing version for promotion to main"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # Make sure we're on the promotion branch
          git checkout $BRANCH_NAME
          git pull origin $BRANCH_NAME

          # Get current version from Cargo.toml (after merge)
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Current version (from merged code): $CURRENT_VERSION"

          # Get the version that was on main before the merge
          # Look at the parent commit (before merge) - this is the main branch state
          PREVIOUS_VERSION=$(git show HEAD^:Cargo.toml 2>/dev/null | grep '^version = ' | sed 's/version = "\(.*\)"/\1/' || echo "$CURRENT_VERSION")
          echo "Previous version on main (before merge): $PREVIOUS_VERSION"

          # Parse versions
          IFS='.' read -r CURR_MAJOR CURR_MINOR CURR_PATCH <<< "$CURRENT_VERSION"
          IFS='.' read -r PREV_MAJOR PREV_MINOR PREV_PATCH <<< "$PREVIOUS_VERSION"

          # Only increment patch if major/minor haven't changed
          if [ "$CURR_MAJOR" == "$PREV_MAJOR" ] && [ "$CURR_MINOR" == "$PREV_MINOR" ]; then
            NEW_PATCH=$((CURR_PATCH + 1))
            NEW_VERSION="$CURR_MAJOR.$CURR_MINOR.$NEW_PATCH"
            echo "Incrementing patch version: $CURRENT_VERSION -> $NEW_VERSION"
            
            # Update Cargo.toml
            sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
            git add Cargo.toml
            
            # Commit the version increment with [skip ci] to prevent triggering another build
            git commit -m "chore: increment version to $NEW_VERSION [skip ci]

          Version incremented as part of promotion from beta to main
          Previous version: $CURRENT_VERSION
          New version: $NEW_VERSION"
            
            # Push the version increment to the promotion branch
            git push origin $BRANCH_NAME
            
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "should_increment=true" >> $GITHUB_OUTPUT
            echo "✓ Version bumped to $NEW_VERSION and pushed to promotion branch"
          else
            echo "Major or minor version changed - not auto-incrementing patch"
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "should_increment=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        id: create_pr
        uses: actions/github-script@v7
        env:
          VERSION_INCREMENTED: ${{ steps.increment_version.outputs.should_increment }}
          NEW_VERSION: ${{ steps.increment_version.outputs.version }}
        with:
          script: |
            const from = '${{ github.event.inputs.from_branch }}';
            const to = '${{ github.event.inputs.to_branch }}';
            const branch = '${{ steps.create_branch.outputs.branch }}';

            const versionIncremented = process.env.VERSION_INCREMENTED === 'true';
            const newVersion = process.env.NEW_VERSION || '';

            const versionInfo = versionIncremented 
              ? `\n\n✅ **Version incremented:** \`${newVersion}\` (included in this PR)`
              : '';

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Promote code from ${from} to ${to}`,
              head: branch,
              base: to,
              body: `## Promotion: ${from} → ${to}
              
              This PR promotes code from the \`${from}\` branch to the \`${to}\` branch.
              
              **Source:** \`${from}\`
              **Target:** \`${to}\`
              **Triggered by:** @${{ github.actor }}
              **Workflow run:** ${{ github.run_id }}${versionInfo}
              
              ---
              *This PR was created automatically by the promotion workflow.*
              `,
              maintainer_can_modify: false
            });

            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);
            if (versionIncremented) {
              core.setOutput('version', newVersion);
              core.setOutput('should_increment', 'true');
            }
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

  approve-and-merge-pr:
    name: Approve and Merge PR
    runs-on: ubuntu-latest
    needs: create-promotion-pr
    if: needs.create-promotion-pr.result == 'success'
    environment:
      name: ${{ github.event.inputs.to_branch }}-promotion
    steps:
      - name: Wait for PR approval
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Approval Required: Merge Promotion PR"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "A pull request has been created to promote code:"
          echo "  From: ${{ github.event.inputs.from_branch }}"
          echo "  To: ${{ github.event.inputs.to_branch }}"
          echo ""
          echo "PR: ${{ needs.create-promotion-pr.outputs.pr_url }}"
          echo ""
          echo "Please review and approve the PR to continue with the merge."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Merge Pull Request
        id: merge_pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.create-promotion-pr.outputs.pr_number }};
            const to = '${{ github.event.inputs.to_branch }}';

            // Check if PR is mergeable
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            if (pr.state !== 'open') {
              core.setFailed(`PR #${prNumber} is not open (state: ${pr.state})`);
              return;
            }

            if (!pr.mergeable) {
              core.setFailed(`PR #${prNumber} is not mergeable. Please resolve conflicts.`);
              return;
            }

            // Merge the PR
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'merge',
              commit_title: `Promote code from ${{ github.event.inputs.from_branch }} to ${to}`
            });

            console.log(`✓ Successfully merged PR #${prNumber}`);
            core.setOutput('merged', 'true');

  create-tag:
    name: Create Tag
    runs-on: ubuntu-latest
    needs: [create-promotion-pr, approve-and-merge-pr]
    if: |
      needs.approve-and-merge-pr.result == 'success' &&
      github.event.inputs.create_tag == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Create and push tag
        id: create_tag
        run: |
          TO="${{ github.event.inputs.to_branch }}"

          # Fetch latest
          git fetch origin $TO
          git checkout $TO

          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            TAG_NAME="promotion-$TO-$TIMESTAMP"
          fi

          # Create and push tag
          git tag -a "$TAG_NAME" -m "Promotion tag: ${{ github.event.inputs.from_branch }} -> $TO

          Created via GitHub Actions promotion workflow
          Source: ${{ github.event.inputs.from_branch }}
          Target: $TO
          Triggered by: ${{ github.actor }}
          Workflow run: ${{ github.run_id }}"

          git push origin "$TAG_NAME"

          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "✓ Created and pushed tag: $TAG_NAME"

  promotion-summary:
    name: Promotion Summary
    runs-on: ubuntu-latest
    needs: [create-promotion-pr, approve-and-merge-pr]
    if: always()
    steps:
      - name: Create summary
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Promotion Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Source branch: $FROM"
          echo "Target branch: $TO"
          echo ""
          if [ "${{ needs.approve-and-merge-pr.result }}" == "success" ]; then
            echo "✓ PR created and merged successfully"
            echo "PR: ${{ needs.create-promotion-pr.outputs.pr_url }}"
            if [ "$FROM" == "beta" ] && [ "$TO" == "main" ]; then
              if [ "${{ needs.create-promotion-pr.outputs.should_increment }}" == "true" ]; then
                echo "✓ Version incremented: ${{ needs.create-promotion-pr.outputs.version }} (included in PR)"
              else
                echo "⚠ Version increment skipped (major/minor changed)"
              fi
            fi
          else
            echo "⚠ Promotion incomplete or failed"
          fi
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
