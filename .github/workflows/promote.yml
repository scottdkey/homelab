name: Promote Code

on:
  workflow_dispatch:
    inputs:
      from_branch:
        description: "Source branch to promote from"
        required: true
        type: choice
        options:
          - alpha
          - beta
      to_branch:
        description: "Target branch to promote to"
        required: true
        type: choice
        options:
          - beta
          - main
      create_tag:
        description: "Create a tag for this promotion"
        required: false
        type: boolean
        default: false
      tag_name:
        description: "Tag name (optional, defaults to promotion-{timestamp})"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-promotion:
    name: Validate Promotion
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate promotion path
        id: validate
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          # Validate promotion path
          if [ "$FROM" == "alpha" ] && [ "$TO" == "beta" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✓ Valid promotion: alpha -> beta"
          elif [ "$FROM" == "beta" ] && [ "$TO" == "main" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "✓ Valid promotion: beta -> main"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "✗ Invalid promotion path: $FROM -> $TO"
            echo "  Valid paths: alpha -> beta, beta -> main"
            exit 1
          fi

      - name: Check if branches exist
        id: check_branches
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          # Fetch all branches
          git fetch --all

          # Check if source branch exists
          if ! git show-ref --verify --quiet refs/remotes/origin/$FROM; then
            echo "✗ Source branch '$FROM' does not exist"
            exit 1
          fi

          # Check if target branch exists
          if ! git show-ref --verify --quiet refs/remotes/origin/$TO; then
            echo "✗ Target branch '$TO' does not exist"
            exit 1
          fi

          echo "✓ Both branches exist"

      - name: Check for uncommitted changes
        id: check_changes
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          # Get latest commits from both branches
          git fetch origin $FROM 2>/dev/null || true
          git fetch origin $TO 2>/dev/null || true

          # Check if source has commits not in target
          COMMITS_AHEAD=$(git rev-list --count origin/$TO..origin/$FROM 2>/dev/null || echo "0")

          if [ "$COMMITS_AHEAD" == "0" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "⚠ No new commits to promote (target branch is up to date)"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✓ Found $COMMITS_AHEAD commit(s) to promote"
            
            # List commits that will be promoted
            echo ""
            echo "Commits to be promoted:"
            git log --oneline origin/$TO..origin/$FROM | head -10
          fi

  promote:
    name: Promote Code
    runs-on: ubuntu-latest
    needs: validate-promotion
    if: needs.validate-promotion.outputs.valid == 'true'
    environment:
      name: ${{ github.event.inputs.to_branch }}-promotion
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Fetch all branches
        run: |
          git fetch --all

      - name: Checkout target branch
        run: |
          TO="${{ github.event.inputs.to_branch }}"
          git checkout -b $TO origin/$TO || git checkout $TO
          git pull origin $TO

      - name: Increment version (for beta -> main promotion)
        if: github.event.inputs.from_branch == 'beta' && github.event.inputs.to_branch == 'main'
        id: increment_version
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Incrementing version for promotion to main"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # Get current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Get previous version from main branch to compare
          git fetch origin main:main || true
          PREVIOUS_VERSION=$(git show main:Cargo.toml 2>/dev/null | grep '^version = ' | sed 's/version = "\(.*\)"/\1/' || echo "$CURRENT_VERSION")
          echo "Previous version on main: $PREVIOUS_VERSION"

          # Parse versions
          IFS='.' read -r CURR_MAJOR CURR_MINOR CURR_PATCH <<< "$CURRENT_VERSION"
          IFS='.' read -r PREV_MAJOR PREV_MINOR PREV_PATCH <<< "$PREVIOUS_VERSION"

          # Only increment patch if major/minor haven't changed
          if [ "$CURR_MAJOR" == "$PREV_MAJOR" ] && [ "$CURR_MINOR" == "$PREV_MINOR" ]; then
            NEW_PATCH=$((CURR_PATCH + 1))
            NEW_VERSION="$CURR_MAJOR.$CURR_MINOR.$NEW_PATCH"
            echo "Incrementing patch version: $CURRENT_VERSION -> $NEW_VERSION"
            
            # Update Cargo.toml
            sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
            git add Cargo.toml
            
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "should_increment=true" >> $GITHUB_OUTPUT
            echo "✓ Version will be bumped to $NEW_VERSION"
          else
            echo "Major or minor version changed - not auto-incrementing patch"
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "should_increment=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge source branch
        id: merge
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Promoting code: $FROM -> $TO"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # Fetch latest from source branch
          git fetch origin $FROM

          # Get commit info before merge
          COMMIT_COUNT=$(git rev-list --count HEAD..origin/$FROM 2>/dev/null || echo "0")

          if [ "$COMMIT_COUNT" == "0" ]; then
            echo "⚠ No new commits to merge. Target branch is already up to date."
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build commit message
          COMMIT_MSG="chore: promote code from $FROM to $TO

          Promoted via GitHub Actions workflow
          Source: $FROM
          Target: $TO
          Triggered by: ${{ github.actor }}
          Workflow run: ${{ github.run_id }}"

          # Add version increment to commit message if version was incremented
          if [ "${{ steps.increment_version.outputs.should_increment }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG

          Version incremented: ${{ steps.increment_version.outputs.version }} [skip ci]"
          fi

          # Attempt merge (no-ff to preserve history)
          if git merge --no-ff --no-edit origin/$FROM -m "$COMMIT_MSG"; then
            echo "merged=true" >> $GITHUB_OUTPUT
            echo "✓ Successfully merged $FROM into $TO"
          else
            echo "merged=false" >> $GITHUB_OUTPUT
            echo "✗ Merge failed - there may be conflicts"
            echo "Please resolve conflicts manually and retry"
            git merge --abort 2>/dev/null || true
            exit 1
          fi

          # If version was incremented, commit it as part of the merge
          if [ "${{ steps.increment_version.outputs.should_increment }}" == "true" ] && [ -n "$(git status --porcelain Cargo.toml)" ]; then
            echo "Committing version increment..."
            git add Cargo.toml
            git commit --amend --no-edit
            echo "✓ Version increment included in promotion commit"
          fi

      - name: Push to target branch
        if: steps.merge.outputs.merged == 'true'
        run: |
          TO="${{ github.event.inputs.to_branch }}"
          echo "Pushing to $TO branch..."
          git push origin $TO
          echo "✓ Successfully pushed to $TO"

      - name: Create tag
        if: |
          steps.merge.outputs.merged == 'true' &&
          github.event.inputs.create_tag == 'true'
        id: create_tag
        run: |
          TO="${{ github.event.inputs.to_branch }}"

          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            TAG_NAME="promotion-$TO-$TIMESTAMP"
          fi

          # Create and push tag
          git tag -a "$TAG_NAME" -m "Promotion tag: ${{ github.event.inputs.from_branch }} -> $TO

          Created via GitHub Actions promotion workflow
          Source: ${{ github.event.inputs.from_branch }}
          Target: $TO
          Triggered by: ${{ github.actor }}
          Workflow run: ${{ github.run_id }}"

          git push origin "$TAG_NAME"

          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "✓ Created and pushed tag: $TAG_NAME"

      - name: Create summary
        if: always()
        run: |
          FROM="${{ github.event.inputs.from_branch }}"
          TO="${{ github.event.inputs.to_branch }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Promotion Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Source branch: $FROM"
          echo "Target branch: $TO"
          echo "Status: ${{ steps.merge.outputs.merged == 'true' && 'Success' || 'Failed/Skipped' }}"
          if [ "${{ steps.merge.outputs.merged }}" == "true" ]; then
            echo "✓ Code successfully promoted from $FROM to $TO"
            if [ "${{ github.event.inputs.create_tag }}" == "true" ]; then
              echo "Tag created: ${{ steps.create_tag.outputs.tag }}"
            fi
          else
            echo "⚠ No changes to promote or merge failed"
          fi
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
